name: Build Arsenal Image Mounter .NET 8 Self-Contained (Portable)

on:
  workflow_dispatch: {}
  push:
    branches:
      - main

jobs:
  build: # This is the job name
    runs-on: windows-latest # Line 10 (now correctly indented under 'build:')

    steps:
      - name: Checkout source
        uses: actions/checkout@v4

      - name: Setup .NET 8 SDK
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '8.0.x'

      - name: Restore dependencies
        # working-directory should be applied to the step, not a sub-property
        # You also cannot have two 'run:' commands under one step definition
        run: |
          dotnet restore src/Arsenal.ImageMounter.Gui/Arsenal.ImageMounter.Gui.csproj
          dotnet restore src/Arsenal.ImageMounter.Cli/Arsenal.ImageMounter.Cli.csproj

      - name: Build GUI (self-contained)
        run: dotnet publish src/Arsenal.ImageMounter.Gui/Arsenal.ImageMounter.Gui.csproj -c Release -f net8.0-windows -r win-x64 --self-contained true /p:PublishSingleFile=true /p:IncludeNativeLibrariesForSelfExtract=true

      - name: Build CLI (self-contained)
        run: dotnet publish src/Arsenal.ImageMounter.Cli/Arsenal.ImageMounter.Cli.csproj -c Release -f net8.0-windows -r win-x64 --self-contained true /p:PublishSingleFile=true /p:IncludeNativeLibrariesForSelfExtract=true

      - name: Prepare portable folder
        run: |
          mkdir portable
          if (Test-Path .\PortableBase) {
            Copy-Item -Path .\PortableBase\* -Destination portable\ -Recurse
          }
          Copy-Item src\Arsenal.ImageMounter.Gui\bin\Release\net8.0-windows\win-x64\publish\* portable\ -Force
          Copy-Item src\Arsenal.ImageMounter.Cli\bin\Release\net8.0-windows\win-x64\publish\* portable\ -Force
          
      - name: Package portable build
        run: powershell Compress-Archive -Path portable\* -DestinationPath AIM-dotnet8-portable.zip

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: AIM-dotnet8-portable
          path: AIM-dotnet8-portable.zip
