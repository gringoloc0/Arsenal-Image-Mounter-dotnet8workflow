name: Build Arsenal Image Mounter .NET 8 Self-Contained (Portable)

on:
  workflow_dispatch: {}
  push:
    branches:
      - main

jobs:
  build:
    runs-on: windows-latest

    steps:
      - name: Checkout workflow repository
        uses: actions/checkout@v4

      - name: Checkout main source code repository
        uses: actions/checkout@v4
        with:
          repository: ArsenalRecon/Arsenal-Image-Mounter
          path: src_repo

      # You can keep this list step or remove it now if you are confident in the fix
      - name: List files for debugging purposes
        run: Get-ChildItem -Path src_repo -Recurse

      - name: Setup .NET 8 SDK
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '8.0.x'

      - name: Restore dependencies
        # Corrected paths (removed the extra /src/)
        run: |
          dotnet restore src_repo/Arsenal.ImageMounter.Gui/Arsenal.ImageMounter.Gui.csproj
          dotnet restore src_repo/Arsenal.ImageMounter.Cli/Arsenal.ImageMounter.Cli.csproj

      - name: Build GUI (self-contained)
        # Corrected paths
        run: dotnet publish src_repo/Arsenal.ImageMounter.Gui/Arsenal.ImageMounter.Gui.csproj -c Release -f net8.0-windows -r win-x64 --self-contained true /p:PublishSingleFile=true /p:IncludeNativeLibrariesForSelfExtract=true

      - name: Build CLI (self-contained)
        # Corrected paths
        run: dotnet publish src_repo/Arsenal.ImageMounter.Cli/Arsenal.ImageMounter.Cli.csproj -c Release -f net8.0-windows -r win-x64 --self-contained true /p:PublishSingleFile=true /p:IncludeNativeLibrariesForSelfExtract=true

      - name: Prepare portable folder
        run: |
          mkdir portable
          if (Test-Path .\PortableBase) {
            Copy-Item -Path .\PortableBase\* -Destination portable\ -Recurse
          }
          # Corrected paths
          Copy-Item src_repo\Arsenal.ImageMounter.Gui\bin\Release\net8.0-windows\win-x64\publish\* portable\ -Force
          Copy-Item src_repo\Arsenal.ImageMounter.Cli\bin\Release\net8.0-windows\win-x64\publish\* portable\ -Force
          
      - name: Package portable build
        run: powershell Compress-Archive -Path portable\* -DestinationPath AIM-dotnet8-portable.zip

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: AIM-dotnet8-portable
          path: AIM-dotnet8-portable.zip
