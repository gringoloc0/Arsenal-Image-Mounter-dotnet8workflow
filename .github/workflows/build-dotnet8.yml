name: Build Arsenal Image Mounter .NET 8 Self-Contained (Portable)

on:
  workflow_dispatch: {}
  push:
    branches:
      - main

jobs:
  build:
    runs-on: windows-latest

    steps:
      - name: Checkout workflow repository
        # This action checks out the repository that holds this YAML file
        uses: actions/checkout@v4

      - name: Checkout main source code repository
        # This step downloads the actual source code where .csproj files live
        uses: actions/checkout@v4
        with:
          repository: ArsenalRecon/Arsenal-Image-Mounter # Corrected repository path
          path: src_repo # Places the code into a folder named 'src_repo'

      - name: Setup .NET 8 SDK
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '8.0.x'

      - name: Restore dependencies
        # Adjusting paths to point into the 'src_repo' directory
        run: |
          dotnet restore src_repo/src/Arsenal.ImageMounter.Gui/Arsenal.ImageMounter.Gui.csproj
          dotnet restore src_repo/src/Arsenal.ImageMounter.Cli/Arsenal.ImageMounter.Cli.csproj

      - name: Build GUI (self-contained)
        # Adjusting paths
        run: dotnet publish src_repo/src/Arsenal.ImageMounter.Gui/Arsenal.ImageMounter.Gui.csproj -c Release -f net8.0-windows -r win-x64 --self-contained true /p:PublishSingleFile=true /p:IncludeNativeLibrariesForSelfExtract=true

      - name: Build CLI (self-contained)
        # Adjusting paths
        run: dotnet publish src_repo/src/Arsenal.ImageMounter.Cli/Arsenal.ImageMounter.Cli.csproj -c Release -f net8.0-windows -r win-x64 --self-contained true /p:PublishSingleFile=true /p:IncludeNativeLibrariesForSelfExtract=true

      - name: Prepare portable folder
        # Adjusting paths
        run: |
          mkdir portable
          if (Test-Path .\PortableBase) {
            Copy-Item -Path .\PortableBase\* -Destination portable\ -Recurse
          }
          # Copying files from the new source repo path
          Copy-Item src_repo\src\Arsenal.ImageMounter.Gui\bin\Release\net8.0-windows\win-x64\publish\* portable\ -Force
          Copy-Item src_repo\src\Arsenal.ImageMounter.Cli\bin\Release\net8.0-windows\win-x64\publish\* portable\ -Force
          
      - name: Package portable build
        run: powershell Compress-Archive -Path portable\* -DestinationPath AIM-dotnet8-portable.zip

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: AIM-dotnet8-portable
          path: AIM-dotnet8-portable.zip
